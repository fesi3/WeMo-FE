name: WeMo CI
on:
  push:
    branches:
      - dev
      - "feat/**"

env:
  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
jobs:
  run-test-and-build:
    name: Run Test and Build
    runs-on: ubuntu-latest
    steps:
      - name: Get Codes
        uses: actions/checkout@v4

      - name: Cache node_modules
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/next.config.js', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - if: steps.yarn-cache.outputs.cache-hit == 'true'
        run: echo 'yarn-cache hit!'

      - if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: echo 'yarn-cache missed!'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # - name: Run Test
      #   run: yarn run test

      - name: Run Build
        run: yarn run build

  create-pr:
    needs: run-test-and-build
    name: Create PR
    runs-on: ubuntu-latest
    steps:
      - name: Get Codes
        uses: actions/checkout@v4

      - name: Create PR
        if: startsWith(github.ref, 'refs/heads/feat/') || github.ref == 'refs/heads/dev'
        uses: peter-evans/create-pull-request@v7
        with:
          title: |
            ${{ 
              startsWith(github.ref, 'refs/heads/feat/') && 
              'feature 브랜치 작업으로 자동 생성된 PR 입니다.' || 
              'dev 브랜치 작업으로 자동 생성된 PR 입니다.' 
            }}

          body: |
            ## 🛠 Merge Details
            - **Source Branch**: `{{ github.head_ref }}`
            - **Target Branch**: `{{ github.base_ref }}`
            - This PR merges the feature branch into the development branch if it's from `feat/*` or merges `dev` into `main`.
          
            ## 📝 Work Content
            <!-- Describe the specific work included in this PR. Include key changes, bug fixes, or features implemented. -->
          
            ## 📸 Screenshot (Optional)
            <!-- If you have screenshots to showcase your changes, add them here. -->
          
            ## ✅ Review Requirements
            - Please verify:
              1. Code quality and adherence to standards.
              2. No breaking changes introduced.
              3. Tests, if applicable, have been updated or added.
          
            > <!-- Additional notes for the reviewer -->


          base: ${{ github.ref == 'dev' && 'main' || 'dev' }}
          branch: ${{ github.ref }}
          token: ${{ secrets.ACCESS_TOKEN_FOR_CI }}